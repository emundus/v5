var FbDateTime=new Class({Extends:FbElement,options:{dateTimeFormat:"",calendarSetup:{eventName:"click",ifFormat:"%Y/%m/%d",daFormat:"%Y/%m/%d",singleClick:true,align:"Br",range:[1900,2999],showsTime:false,timeFormat:"24",electric:true,step:2,cache:false,showOthers:false,advanced:false}},initialize:function(b,a){if(!this.parent(b,a)){return false}this.hour="0";this.plugin="fabrikdate";this.minute="00";this.buttonBg="#ffffff";this.buttonBgSelected="#88dd33";this.startElement=b;this.setUpDone=false;this.setUp()},setUp:function(){if(this.options.editable){this.watchButtons();if(this.options.typing===false){this.disableTyping()}else{this.getDateField().addEvent("blur",function(c){var b=this.getDateField().value;if(b!==""){var f;if(this.options.advanced){f=Date.parseExact(b,Date.normalizeFormat(this.options.calendarSetup.ifFormat))}else{f=Date.parseDate(b,this.options.calendarSetup.ifFormat)}this.setTimeFromField(f);this.update(f)}else{this.options.value=""}}.bind(this))}this.makeCalendar();var a=function(){this.cal.hide()};a.delay(100,this);this.element.getElement("img.calendarbutton").addEvent("click",function(b){if(!this.cal.params.position){this.cal.showAtElement(this.cal.params.button||this.cal.params.displayArea||this.cal.params.inputField,this.cal.params.align)}else{this.cal.showAt(this.cal.params.position[0],params.position[1])}this.cal.show()}.bind(this));Fabrik.addEvent("fabrik.form.submit.failed",function(c,b){this.afterAjaxValidation()}.bind(this))}},dateSelect:function(date){var fn=this.options.calendarSetup.dateAllowFunc;if(typeOf(fn)!=="null"&&fn!==""){eval(fn);return result}},calSelect:function(b,a){if(!this.dateSelect(a)){var c=this.setTimeFromField(b.date);this.update(c.format("db"));if(this.cal.dateClicked){this.getDateField().fireEvent("change");if(this.timeButton){this.getTimeField().fireEvent("change")}this.cal.callCloseHandler()}window.fireEvent("fabrik.date.select",this);Fabrik.fireEvent("fabrik.date.select",this)}},calClose:function(a){this.cal.hide();window.fireEvent("fabrik.date.close",this);if(this.options.validations){this.form.doElementValidation(this.options.element)}},onsubmit:function(){var a=this.getValue();if(a!==""){if(this.options.editable){this.getDateField().value=a}}return true},afterAjaxValidation:function(){this.update(this.getValue())},makeCalendar:function(){if(this.cal){this.cal.show();return}var a=false;this.addEventToCalOpts();var f=this.options.calendarSetup;var g=["displayArea","button"];for(i=0;i<g.length;i++){if(typeof f[g[i]]==="string"){f[g[i]]=document.getElementById(f[g[i]])}}f.inputField=this.getDateField();var e=f.inputField||f.displayArea;var l=f.inputField?f.ifFormat:f.daFormat;this.cal=null;if(e){if(this.options.advanced){f.date=Date.parseExact(e.value||e.innerHTML,Date.normalizeFormat(l))}else{f.date=Date.parseDate(e.value||e.innerHTML,l)}}this.cal=new Calendar(f.firstDay,f.date,f.onSelect,f.onClose);this.cal.setDateStatusHandler(f.dateStatusFunc);this.cal.setDateToolTipHandler(f.dateTooltipFunc);this.cal.showsTime=f.showsTime;this.cal.time24=(f.timeFormat.toString()==="24");this.cal.weekNumbers=f.weekNumbers;if(f.multiple){cal.multiple={};for(i=f.multiple.length;--i>=0;){var h=f.multiple[i];var b=h.print("%Y%m%d");this.cal.multiple[b]=h}}this.cal.showsOtherMonths=f.showOthers;this.cal.yearStep=f.step;this.cal.setRange(f.range[0],f.range[1]);this.cal.params=f;this.cal.getDateText=f.dateText;this.cal.setDateFormat(l);this.cal.create();this.cal.refresh();this.cal.hide();var k=this.cal;var j=f.button||f.displayArea||f.inputField;this.cal.show=function(){Calendar.prototype.show.call(k);document.id(this.cal.element).position({relativeTo:j,position:"upperRight",edge:"bottomLeft"})}.bind(this)},disableTyping:function(){if(typeOf(this.element)==="null"){fconsole(element+": not date element container - is this a custom template with a missing $element->containerClass div/li surrounding the element?");return}this.element.setProperty("readonly","readonly");this.element.getElements(".fabrikinput").each(function(a){a.addEvent("focus",function(b){this._disabledShowCalTime(a,b)}.bind(this));a.addEvent("click",function(b){this._disabledShowCalTime(a,b)}.bind(this))}.bind(this))},_disabledShowCalTime:function(a,b){if(typeOf(b)==="null"){return}if(b.target.hasClass("timeField")){this.getContainer().getElement(".timeButton").fireEvent("click")}else{this.options.calendarSetup.inputField=b.target.id;this.options.calendarSetup.button=this.element.id+"_img";this.cal.showAtElement(a,this.cal.params.align)}},getValue:function(){var b;if(!this.options.editable){return this.options.value}this.getElement();if(this.cal){var a=this.getDateField().value;if(a===""){return""}var c=new RegExp("\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}");if(a.match(c)!==null){return a}b=this.cal.date}else{if(this.options.value===""||this.options.value===null){return""}b=new Date.parse(this.options.value)}b=this.setTimeFromField(b);return b.format("db")},hasSeconds:function(){if(this.options.showtime===true&&this.timeElement){if(this.options.dateTimeFormat.contains("%S")){return true}if(this.options.dateTimeFormat.contains("%T")){return true}}return false},setTimeFromField:function(j){if(this.options.showtime===true&&this.timeElement){var g=this.timeElement.get("value").toUpperCase();var b=g.contains("PM")?true:false;g=g.replace("PM","").replace("AM","");var c=g.split(":");var f=c[0]?c[0].toInt():0;if(b){f+=12}var a=c[1]?c[1].toInt():0;j.setHours(f);j.setMinutes(a);if(c[2]&&this.hasSeconds()){var e=c[2]?c[2].toInt():0;j.setSeconds(e)}else{j.setSeconds(0)}}else{}return j},watchButtons:function(){if(this.options.showtime&this.options.editable){this.getTimeField();this.getTimeButton();if(this.timeButton){this.timeButton.removeEvents("click");this.timeButton.addEvent("click",function(){this.showTime()}.bind(this));if(!this.setUpDone){if(this.timeElement){this.dropdown=this.makeDropDown();this.setAbsolutePos(this.timeElement);this.setUpDone=true}}}}},addNewEventAux:function(action,js){if(action==="change"){Fabrik.addEvent("fabrik.date.select",function(){var e="fabrik.date.select";typeOf(js)==="function"?js.delay(0,this,this):eval(js)})}this.element.getElements("input").each(function(i){i.addEvent(action,function(e){if(typeOf(e)==="event"){e.stop()}typeOf(js)==="function"?js.delay(0,this,this):eval(js)})}.bind(this))},update:function(c){this.getElement();if(c==="invalid date"){fconsole(this.element.id+": date not updated as not valid");return}var a;if(typeOf(c)==="string"){a=Date.parse(c);if(a===null){this._getSubElements().each(function(d){d.value=""});if(this.cal){this.cal.date=new Date()}return}}else{a=c}var b=this.options.calendarSetup.ifFormat;if(this.options.dateTimeFormat!==""&&this.options.showtime){b+=" "+this.options.dateTimeFormat}this.fireEvents(["change"]);if(typeOf(c)==="null"||c===false){return}if(!this.options.editable){if(typeOf(this.element)!=="null"){this.element.set("html",a.print(b))}return}if(this.options.hidden){a=a.print(b);this.getDateField().value=a;return}else{this.getTimeField();this.hour=a.get("hours");this.minute=a.get("minutes");this.second=a.get("seconds");this.stateTime()}this.cal.date=a;this.getDateField().value=a.print(this.options.calendarSetup.ifFormat)},getDateField:function(){return this.element.getElement(".fabrikinput")},getTimeField:function(){this.timeElement=this.getContainer().getElement(".timeField");return this.timeElement},getTimeButton:function(){this.timeButton=this.getContainer().getElement(".timeButton");return this.timeButton},getAbsolutePos:function(b){var c={x:b.offsetLeft,y:b.offsetTop};if(b.offsetParent){var a=this.getAbsolutePos(b.offsetParent);c.x+=a.x;c.y+=a.y}return c},setAbsolutePos:function(a){var b=this.getAbsolutePos(a);this.dropdown.setStyles({position:"absolute",left:b.x,top:b.y+30})},makeDropDown:function(){var b=null;var e=new Element("div",{styles:{height:"20px",curor:"move",color:"#dddddd",padding:"2px;","background-color":"#333333"},id:this.startElement+"_handle"}).set("html",this.options.timelabel+'<a href="#" style="color:#eee" class="close">[x]</a>');var g=new Element("div",{className:"fbDateTime",styles:{"z-index":999999,display:"none",cursor:"move",width:"264px",height:"125px",border:"1px solid #999999",backgroundColor:"#EEEEEE"}});g.appendChild(e);for(var a=0;a<24;a++){b=new Element("div",{styles:{width:"20px","float":"left",cursor:"pointer","background-color":"#ffffff",margin:"1px","text-align":"center"}});b.innerHTML=a;b.className="fbdateTime-hour";g.appendChild(b);document.id(b).addEvent("click",function(d){this.hour=d.target.innerHTML;this.stateTime();this.setActive()}.bind(this));document.id(b).addEvent("mouseover",function(d){if(this.hour!==d.target.innerHTML){d.target.setStyles({background:"#cbeefb"})}}.bind(this));document.id(b).addEvent("mouseout",function(d){if(this.hour!==d.target.innerHTML){b.setStyles({background:this.buttonBg})}}.bind(this))}var c=new Element("div",{styles:{clear:"both",paddingTop:"5px"}});for(a=0;a<12;a++){b=new Element("div",{styles:{width:"41px","float":"left",cursor:"pointer",background:"#ffffff",margin:"1px","text-align":"center"}});b.setStyles();b.innerHTML=":"+(a*5);b.className="fbdateTime-minute";c.appendChild(b);document.id(b).addEvent("click",function(d){this.minute=this.formatMinute(d.target.innerHTML);this.stateTime();this.setActive()}.bind(this));b.addEvent("mouseover",function(k){var d=k.target;if(this.minute!==this.formatMinute(d.innerHTML)){k.target.setStyles({background:"#cbeefb"})}}.bind(this));b.addEvent("mouseout",function(k){var d=k.target;if(this.minute!==this.formatMinute(d.innerHTML)){k.target.setStyles({background:this.buttonBg})}}.bind(this))}g.appendChild(c);document.addEvent("click",function(h){if(this.timeActive){var d=h.target;if(d!==this.timeButton&&d!==this.timeElement){}}}.bind(this));g.inject(document.body);var f=new Drag.Move(g);var j=e.getElement("a.close");if(typeOf(j)!=="null"){j.addEvent("click",function(d){d.stop();this.hideTime()}.bind(this))}return g},toggleTime:function(){if(this.dropdown.style.display==="none"){this.doShowTime()}else{this.hideTime()}},doShowTime:function(){this.dropdown.setStyles({display:"block"});this.timeActive=true;Fabrik.fireEvent("fabrik.date.showtime",this)},hideTime:function(){this.timeActive=false;this.dropdown.hide();if(this.options.validations!==false){this.form.doElementValidation(this.element.id)}Fabrik.fireEvent("fabrik.date.hidetime",this);Fabrik.fireEvent("fabrik.date.select",this);window.fireEvent("fabrik.date.select",this)},formatMinute:function(a){a=a.replace(":","");a.pad("2","0","left");return a},stateTime:function(){if(this.timeElement){var a=this.hour.toString().pad("2","0","left")+":"+this.minute.toString().pad("2","0","left");if(this.second){a+=":"+this.second.toString().pad("2","0","left")}var b=this.timeElement.value!==a;this.timeElement.value=a;if(b){this.fireEvents(["change"])}}},showTime:function(){this.setAbsolutePos(this.timeElement);this.toggleTime();this.setActive()},setActive:function(){var a=this.dropdown.getElements(".fbdateTime-hour");a.each(function(c){c.setStyles({backgroundColor:this.buttonBg})},this);var b=this.dropdown.getElements(".fbdateTime-minute");b.each(function(c){c.setStyles({backgroundColor:this.buttonBg})},this);a[this.hour.toInt()].setStyles({backgroundColor:this.buttonBgSelected});if(typeOf(b[this.minute/5])!=="null"){b[this.minute/5].setStyles({backgroundColor:this.buttonBgSelected})}},addEventToCalOpts:function(){this.options.calendarSetup.onSelect=function(b,a){this.calSelect(b,a)}.bind(this);this.options.calendarSetup.dateStatusFunc=function(a){return this.dateSelect(a)}.bind(this);this.options.calendarSetup.onClose=function(a){this.calClose(a)}.bind(this);this.options.calendarSetup.onSelected=function(a){console.log("open")}.bind(this)},cloned:function(d){this.setUpDone=false;this.hour=0;delete this.cal;var a=this.element.getElement("img");if(a){a.id=this.element.id+"_cal_img"}var b=this.element.getElement("input");b.id=this.element.id+"_cal";this.options.calendarSetup.inputField=b.id;this.options.calendarSetup.button=this.element.id+"_img";this.makeCalendar();this.cal.hide();this.setUp();this.parent(d)}});